# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Pharaohs Time Tracker is a modern Chrome extension (v2.0) for tracking time spent on different projects and activities. It has been completely refactored from the legacy version to use the latest web technologies and Chrome Extension Manifest V3.

## Architecture

The extension follows Chrome Extension Manifest V3 architecture with modern TypeScript and build tooling:

### Core Structure
- **manifest.json**: Manifest V3 configuration with service worker and modern permissions
- **src/popup/**: Main popup UI (HTML, CSS, TypeScript)
- **src/background/**: Service worker for background operations
- **src/options/**: Settings and data management page
- **src/shared/**: Shared utilities and database layer
- **dist/**: Built extension files (generated by webpack)

### Technology Stack
- **TypeScript**: Strongly typed JavaScript with ES2020+ features
- **Webpack**: Module bundler with development and production builds
- **IndexedDB**: Modern client-side database (replaces deprecated WebSQL)
- **Chrome Extension API v3**: Latest extension APIs with service workers
- **Modern CSS**: Responsive design with CSS Grid and Flexbox
- **ESLint + Prettier**: Code quality and formatting tools

## Build System

### Commands
- `npm run build`: Production build for extension distribution
- `npm run dev`: Development build with watch mode
- `npm run lint`: ESLint code quality checks  
- `npm run format`: Prettier code formatting
- `npm run type-check`: TypeScript type checking without compilation
- `npm test`: Run all tests with Jest
- `npm run test:watch`: Run tests in watch mode for development
- `npm run test:coverage`: Run tests with coverage reporting
- `npm run test:ci`: Run tests for CI environments

### Development Workflow
1. Install dependencies: `npm install`
2. Start development: `npm run dev` (watches for changes)
3. Load `dist/` folder in Chrome as unpacked extension
4. **IMPORTANT**: Always run `npm run lint` and `npm run type-check` before making changes
5. **Extension Loading**: After building, go to `chrome://extensions/`, enable Developer mode, and load the `dist/` folder as unpacked extension

### Build Configuration
- **Webpack**: Uses multiple entry points (background, popup, options)
- **TypeScript**: Compiles to ES2020 with strict mode enabled
- **CSS Processing**: Extracts CSS files separately for better performance
- **Asset Copying**: Static files (HTML, images, manifest) copied to dist/

## Database Architecture

### IndexedDB Structure
- **Database**: `TimeTrackerDB` (version 1)
- **Object Store**: `activities` with auto-incrementing ID
- **Indexes**: 
  - `date`: [year, month, day] for efficient date queries
  - `activity`: Activity name for searching
  - `start`: Start time for chronological ordering

### Activity Interface
```typescript
interface Activity {
  id?: number;
  activity: string;
  description?: string;
  start: Date;
  end?: Date;
  day: number;
  month: number;
  year: number;
}
```

## Key Features

### Core Functionality
- Start/stop activity tracking with real-time badge updates
- Modern popup UI with activity list, date navigation, and inline editing
- Comprehensive options page with settings and data management
- Export data in JSON and CSV formats
- Import data from JSON files
- Usage statistics and analytics

### Modern Enhancements
- Fully responsive design that works on different screen sizes
- Accessibility features with proper ARIA labels and keyboard navigation
- Real-time duration updates in extension badge
- Auto-hiding notifications with user preferences
- Modern modal dialogs for editing activities
- Data validation and error handling

## Core Components

### Database Layer (`src/shared/database.ts`)
- `TimeTrackerDB`: Main database class with IndexedDB operations
- `addActivity()`, `updateActivity()`, `deleteActivity()`: CRUD operations
- `getActivitiesByDate()`: Retrieve activities for specific date
- `getCurrentActivity()`: Get currently running activity
- Singleton pattern with `db` export

### Background Service (`src/background/background.ts`)
- Service worker managing background operations
- Badge updates every 60 seconds for active activities
- Notification management with user preferences
- Message handling for popup/options communication

### Popup Interface (`src/popup/popup.ts`)
- `TimeTrackerPopup`: Main popup controller class
- Activity start/stop functionality
- Date navigation and activity management
- Inline editing with modal dialogs
- Real-time duration display

### Options Page (`src/options/options.ts`)
- `OptionsPage`: Settings and data management controller
- Statistics calculation and display
- Data export/import functionality
- Settings persistence with Chrome Storage API

## File Structure

```
src/
├── background/
│   └── background.ts          # Service worker
├── popup/
│   ├── popup.html            # Popup UI
│   ├── popup.css             # Popup styles
│   └── popup.ts              # Popup logic
├── options/
│   ├── options.html          # Options page UI
│   ├── options.css           # Options page styles
│   └── options.ts            # Options page logic
└── shared/
    ├── database.ts           # IndexedDB wrapper
    └── utils.ts              # Shared utilities
```

## Chrome Extension APIs

### Permissions Used
- `storage`: Settings persistence
- `notifications`: Activity notifications
- `alarms`: Future reminder functionality

### Key APIs
- `chrome.action`: Badge updates and popup management
- `chrome.runtime`: Message passing between components
- `chrome.storage.sync`: Settings synchronization
- `chrome.notifications`: User notifications

## Development Guidelines

- Follow TypeScript strict mode requirements
- Use modern ES2020+ features and async/await
- Implement proper error handling and user feedback
- Maintain responsive design principles
- Follow accessibility best practices
- Use shared utilities for common functionality
- Keep components modular and testable

## Common Development Tasks

### Adding New Features
1. **Database Changes**: Modify `Activity` interface in `src/shared/database.ts` if needed
2. **UI Updates**: Update popup or options HTML/CSS/TypeScript files
3. **Background Logic**: Add service worker functionality in `src/background/background.ts`
4. **Build & Test**: Run `npm run dev` to watch for changes during development

### Debugging Chrome Extensions
- **Service Worker**: Check `chrome://extensions/` → Click extension → "service worker" link
- **Popup**: Right-click extension icon → "Inspect popup"  
- **Options**: Right-click on options page → "Inspect"
- **Storage**: Use Chrome DevTools → Application → Storage to view IndexedDB data

### Message Passing Pattern
Extensions use `chrome.runtime.sendMessage()` for communication:
- **Popup ↔ Background**: Activity start/stop, badge updates
- **Options ↔ Background**: Settings changes, data operations
- **Response Handling**: Always use `sendResponse()` and return `true` for async operations

## Legacy Code Migration

The refactoring replaced:
- jQuery with vanilla TypeScript
- WebSQL with IndexedDB
- Manifest V1 with V3
- Direct script files with webpack build system
- Inline styles with modern CSS architecture